<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Sản phẩm - Quản lý</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body{font-family:'Segoe UI',Roboto,Arial;background:#f5f7fa;padding:20px}
        .navbar-custom{background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);padding:16px 20px;margin:-20px -20px 24px -20px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
        .navbar-custom a{color:#fff;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:6px}
        .navbar-custom a:hover{opacity:0.8}
        .page-title{color:#333;font-weight:700;font-size:1.8rem;margin:0}
        .main-container{max-width:1200px;margin:0 auto}
        .section-card{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-left:4px solid #667eea}
        .section-title{font-size:1.2rem;font-weight:600;color:#333;margin-bottom:16px}
        .btn-group-custom{display:flex;gap:8px;margin-bottom:16px}
        table{margin-bottom:0}
        table th{background:#f8f9fa;font-weight:600;color:#333;border-bottom:2px solid #dee2e6}
        table td{vertical-align:middle;color:#555}
        table tbody tr:hover{background:#f8f9fa}
        .form-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;align-items:end}
        .status-text{font-size:0.9rem;color:#666}
        .empty-state{text-align:center;padding:40px;color:#999}
        .empty-state i{font-size:3rem;margin-bottom:12px;opacity:0.5}
    </style>
</head>
<body>
<div class="navbar-custom">
    <a href="/"><i class="bi bi-house-fill"></i>Trang chủ</a>
</div>

<div class="main-container">
    <h1 class="page-title"><i class="bi bi-bag-fill"></i> Quản lý Sản phẩm</h1>

    <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title">Danh sách sản phẩm</h5>
            <div>
                <button id="refresh" class="btn btn-sm btn-primary"><i class="bi bi-arrow-clockwise"></i> Tải lại</button>
                <button id="createSample" class="btn btn-sm btn-success ms-2"><i class="bi bi-plus-circle"></i> Dữ liệu mẫu</button>
                <span id="status" class="status-text ms-3">&nbsp;</span>
            </div>
        </div>

        <div id="list">
            <div class="table-responsive">
                <table id="productsTable" class="table table-hover align-middle">
                    <thead><tr><th style="width:60px">ID</th><th>Tên sản phẩm</th><th style="width:100px">Giá</th><th style="width:100px">Số lượng</th><th>Người tạo</th><th style="width:120px">Hành động</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="empty" class="empty-state" style="display:none">
                <i class="bi bi-inbox"></i><br/>
                Chưa có sản phẩm nào
            </div>
        </div>
    </div>

    <div class="section-card" style="border-left-color:#51cf66">
        <h5 class="section-title"><i class="bi bi-plus-square"></i> Thêm sản phẩm mới</h5>
        <form id="createForm" class="form-section">
            <div>
                <label class="form-label">Tên sản phẩm</label>
                <input class="form-control form-control-sm" type="text" name="title" placeholder="VD: Laptop Dell" required>
            </div>
            <div>
                <label class="form-label">Giá (VND)</label>
                <input class="form-control form-control-sm" type="number" name="price" step="0.01" placeholder="VD: 15000000" required>
            </div>
            <div>
                <label class="form-label">Số lượng</label>
                <input class="form-control form-control-sm" type="number" name="quantity" placeholder="VD: 10">
            </div>
            <div>
                <label class="form-label">Mô tả</label>
                <input class="form-control form-control-sm" type="text" name="desc" placeholder="VD: Máy tính hiệu năng cao">
            </div>
            <div>
                <label class="form-label">Người tạo</label>
                <select class="form-select form-select-sm" name="userId"><option value="">(Không chọn)</option></select>
            </div>
            <div>
                <label class="form-label">Danh mục</label>
                <select class="form-select form-select-sm" name="categoryIds" multiple size="2"></select>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-plus"></i> Thêm</button>
                <span id="formMsg" class="status-text" style="color:#51cf66"></span>
            </div>
        </form>
    </div>
</div>

<script>
    const graphql = async (query, variables) => {
        const resp = await fetch('/graphql', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({query, variables})
        });
        return resp.json();
    }

    const $ = sel => document.querySelector(sel);

    async function loadData() {
        setStatus('Đang tải...');
        try {
            const q = `query { productsSortedByPriceAsc { id title price quantity user { id fullname } } users { id fullname } categories { id name } }`;
            const res = await graphql(q);
            if (res.errors) throw new Error(res.errors.map(e=>e.message).join('; '));

            const products = res.data.productsSortedByPriceAsc || [];
            const users = res.data.users || [];
            const categories = res.data.categories || [];

            renderProducts(products);
            populateSelects(users, categories);
            setStatus('Đã tải');
        } catch (e) {
            console.error(e); setStatus('Lỗi: ' + e.message, true);
        }
    }

    function renderProducts(products) {
        const tb = document.querySelector('#productsTable tbody'); tb.innerHTML = '';
        if (!products.length) {
            $('#empty').style.display = 'block';
            $('#productsTable').style.display = 'none';
            return;
        }
        $('#empty').style.display = 'none';
        $('#productsTable').style.display = '';
        products.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="fw-bold">${p.id}</td><td>${escapeHtml(p.title)}</td><td>${new Intl.NumberFormat('vi-VN').format(p.price)}</td><td>${p.quantity||'-'}</td><td>${p.user? escapeHtml(p.user.fullname) : '-'}</td><td><button class="btn btn-sm btn-outline-danger del" data-id="${p.id}"><i class="bi bi-trash"></i></button></td>`;
            tb.appendChild(tr);
        });
        document.querySelectorAll('.del').forEach(b=>b.addEventListener('click', onDeleteProduct));
    }

    function populateSelects(users, categories) {
        const userSelect = document.querySelector('select[name="userId"]');
        const catSelect = document.querySelector('select[name="categoryIds"]');
        userSelect.innerHTML = '<option value="">(Không chọn)</option>' + users.map(u=>`<option value="${u.id}">${escapeHtml(u.fullname)}</option>`).join('');
        catSelect.innerHTML = categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[ch]); }

    function setStatus(text, isError) { const el = $('#status'); el.textContent = text; el.style.color = isError? '#dc3545':'#666'; }

    window.addEventListener('load', ()=> loadData());

    $('#refresh').addEventListener('click', ()=> loadData());

    async function onDeleteProduct(ev){
        if(!confirm('Xác nhận xóa sản phẩm này?')) return;
        const id = parseInt(ev.target.closest('button').dataset.id);
        const m = `mutation($id:ID!){ deleteProduct(id:$id) }`;
        const r = await graphql(m,{id});
        if(r.errors) setStatus('Lỗi: '+r.errors[0].message, true);
        else { setStatus('Đã xóa'); await loadData(); }
    }

    $('#createForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const form = ev.target;
        const title = form.title.value.trim();
        const price = parseFloat(form.price.value);
        const quantity = form.quantity.value? parseInt(form.quantity.value): null;
        const desc = form.desc.value.trim() || null;
        const userId = form.userId.value || null;
        const catOptions = Array.from(form.categoryIds.selectedOptions).map(o=>o.value);

        const mutation = `mutation($title:String!,$quantity:Int,$desc:String,$price:Float!,$userId:ID,$categoryIds:[ID!]){ createProduct(title:$title,quantity:$quantity,desc:$desc,price:$price,userId:$userId,categoryIds:$categoryIds){ id title price } }`;
        const vars = { title, quantity, desc, price, userId: userId || null, categoryIds: catOptions };
        setStatus('Đang thêm...');
        try {
            const res = await graphql(mutation, vars);
            if (res.errors) throw new Error(res.errors.map(e=>e.message).join('; '));
            $('#formMsg').textContent = '✓ Đã thêm: ' + (res.data.createProduct.title || '');
            form.reset();
            await loadData();
        } catch (e) { console.error(e); setStatus('Lỗi: '+e.message, true); }
    });

    $('#createSample').addEventListener('click', async ()=>{
        setStatus('Đang tạo dữ liệu mẫu...');
        try {
            let m = `mutation($fullname:String!,$email:String!,$password:String!){ createUser(fullname:$fullname,email:$email,password:$password){ id fullname } }`;
            let vars = { fullname: 'Demo User', email: 'demo@example.com', password: 'demo' };
            let r = await graphql(m, vars);
            const userId = r.data.createUser.id;
            m = `mutation($name:String!){ createCategory(name:$name){ id name } }`;
            vars = { name: 'Demo Category' };
            r = await graphql(m, vars);
            const catId = r.data.createCategory.id;
            m = `mutation($title:String!,$price:Float!,$userId:ID,$categoryIds:[ID!]){ createProduct(title:$title,price:$price,userId:$userId,categoryIds:$categoryIds){ id title } }`;
            vars = { title: 'Demo Product - Laptop', price: 9.99, userId: userId, categoryIds: [catId] };
            await graphql(m, vars);
            await loadData();
            setStatus('✓ Đã tạo dữ liệu mẫu');
        } catch (e) { console.error(e); setStatus('Lỗi: '+e.message, true); }
    });

</script>
</body>
</html>
